name: Deploy to AWS

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: "deploy"
  cancel-in-progress: false

env:
  AWS_REGION: us-east-1
  S3_BUCKET: hausedgecapital.com

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js static site
        run: npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync static assets to S3 (long cache)
        run: |
          aws s3 sync ./out s3://${{ env.S3_BUCKET }} \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html" \
            --exclude "sitemap.xml" \
            --exclude "robots.txt" \
            --exclude "data/generated-posts.json"

      - name: Sync HTML files to S3 (short cache, exclude sitemap)
        run: |
          aws s3 sync ./out s3://${{ env.S3_BUCKET }} \
            --cache-control "public, max-age=3600" \
            --include "*.html" \
            --include "robots.txt" \
            --exclude "sitemap.xml"

      - name: Regenerate sitemap with all posts
        run: |
          # Fetch static and generated posts from S3
          aws s3 cp s3://${{ env.S3_BUCKET }}/data/blog-posts.json /tmp/blog-posts.json || echo "[]" > /tmp/blog-posts.json
          aws s3 cp s3://${{ env.S3_BUCKET }}/data/generated-posts.json /tmp/generated-posts.json || echo "[]" > /tmp/generated-posts.json

          # Generate sitemap with all posts
          node -e "
            const fs = require('fs');
            const staticPosts = JSON.parse(fs.readFileSync('/tmp/blog-posts.json', 'utf8'));
            const generatedPosts = JSON.parse(fs.readFileSync('/tmp/generated-posts.json', 'utf8'));
            const allPosts = [...generatedPosts, ...staticPosts];
            const today = new Date().toISOString().split('T')[0];
            const baseUrl = 'https://hausedgecapital.com';
            const staticPages = ['', '/learn', '/trade', '/lending', '/blog', '/trading-strategies', '/capital-growth', '/daily-updates'];

            const urls = [
              ...staticPages.map(page => \`<url><loc>\${baseUrl}\${page}</loc><lastmod>\${today}</lastmod><changefreq>\${page === '' ? 'weekly' : page === '/blog' || page === '/daily-updates' ? 'daily' : 'monthly'}</changefreq><priority>\${page === '' ? '1.0' : page === '/blog' || page === '/daily-updates' ? '0.9' : '0.8'}</priority></url>\`),
              ...allPosts.map(post => \`<url><loc>\${baseUrl}/blog/\${post.slug}</loc><lastmod>\${post.publishDate || today}</lastmod><changefreq>monthly</changefreq><priority>0.7</priority></url>\`)
            ];

            const sitemap = \`<?xml version=\"1.0\" encoding=\"UTF-8\"?><urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\${urls.join('')}</urlset>\`;

            fs.writeFileSync('/tmp/sitemap.xml', sitemap);
            console.log('Generated sitemap with ' + (staticPages.length + allPosts.length) + ' URLs');
          "

          # Upload regenerated sitemap
          aws s3 cp /tmp/sitemap.xml s3://${{ env.S3_BUCKET }}/sitemap.xml \
            --cache-control "public, max-age=3600" \
            --content-type "application/xml"

      - name: Invalidate CloudFront cache
        env:
          CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          aws cloudfront create-invalidation \
            --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
            --paths "/*"

      - name: Deployment complete
        run: echo "Site deployed to https://hausedgecapital.com"
